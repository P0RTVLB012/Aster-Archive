<!DOCTYPE html>
<html>
<head>
<!-- Firebase SDK - Load FIRST before Cookie Clicker -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDSfxXsKJxJuIVdJ2PJH_sT-yuCfnIcy48",
    authDomain: "the-aster-archive.firebaseapp.com",
    projectId: "the-aster-archive",
    storageBucket: "the-aster-archive.firebasestorage.app",
    messagingSenderId: "477660520567",
    appId: "1:477660520567:web:db80ea1995cb9a594b6672"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.asterDB = db;
  window.asterFirestore = { doc, setDoc, getDoc };
  window.firebaseReady = true;

  console.log('Firebase initialized for Cookie Clicker');

  // Pre-load save data from Firebase
  const currentUser = localStorage.getItem('aster_currentUser') || 'guest';
  const saveKeys = ['CookieClickerGame', 'CookieClickerGameBeta', 'CookieClickerGameBetaDungeons'];

  for (const key of saveKeys) {
    try {
      const saveDoc = await getDoc(doc(db, 'saves', `${currentUser}_cookieclicker_${key}`));
      if (saveDoc.exists()) {
        const data = saveDoc.data().data;
        window.localStorage.setItem(key, data);
        console.log('Pre-loaded from Firebase:', key);
      }
    } catch (error) {
      console.log('Could not pre-load:', key);
    }
  }
</script>

<!-- Override localStorage functions BEFORE main.js loads -->
<script>
// Get current username
const currentUser = localStorage.getItem('aster_currentUser') || 'guest';

// Keep original functions
const originalLocalStorageGet = function(key) {
    let local = '';
    try { local = window.localStorage.getItem(key); } catch (exception) {}
    return local;
};

const originalLocalStorageSet = function(key, str) {
    let local = '';
    try { local = window.localStorage.setItem(key, str); } catch (exception) {}
    return local;
};

// Synchronous wrappers that use localStorage immediately, then sync to Firebase in background
window.localStorageGet = function(key) {
    // Always return localStorage immediately (synchronous)
    return originalLocalStorageGet(key);
};

window.localStorageSet = function(key, str) {
    // Save to localStorage immediately (synchronous)
    originalLocalStorageSet(key, str);

    // Then save to Firebase in the background (async, non-blocking)
    if (key.includes('CookieClickerGame') && window.firebaseReady) {
        setTimeout(async () => {
            try {
                const { doc, setDoc } = window.asterFirestore;
                await setDoc(doc(window.asterDB, 'saves', `${currentUser}_cookieclicker_${key}`), {
                    username: currentUser,
                    game: 'Cookie Clicker',
                    key: key,
                    data: str,
                    lastSaved: new Date().toISOString()
                });
                console.log('✓ Synced to Firebase:', key);
            } catch (error) {
                console.error('✗ Firebase sync failed:', error);
            }
        }, 0);
    }

    return '';
};

console.log('Firebase localStorage override active for user:', currentUser);
</script>

<!-- Original Cookie Clicker code below -->
<!-- external -->
<script type="text/javascript">
    window.cookieconsent_options = {"message":"Unsurprisingly, this website uses cookies for ads and traffic analysis.","dismiss":"Got it!","learnMore":"Learn more","link":"//orteil.dashnet.org/cookieconsentpolicy.html","target":"_blank","theme":"//orteil.dashnet.org/cookieconsent.css","domain":"dashnet.org"};
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>

<link href='https://fonts.googleapis.com/css?family=Merriweather:900&subset=latin,latin-ext' rel='stylesheet' type='text/css'>

<title>Cookie Clicker - Aster Archive</title>

<meta name="viewport" content="width=900, initial-scale=1">
<link rel="shortcut icon" href="img/favicon.ico" />
<script src="base64.js"></script>

<script>
var VERSION=2.052;
var BETA=0;
var App=typeof App==='undefined'?0:App;
</script>

<link href="style.css?v=9" rel="stylesheet" type="text/css">
<script src="main.js?v=10"></script>

<script src="showads.js"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-8491708950677704",
          enable_page_level_ads: true
     });
</script>

<!--[if lt IE9]><script src="excanvas.compiled.js"></script><![endif]-->
</head>
<body>

<div id="wrapper">

        <div id="topBar">
                <div><b style="font-weight:bold;">Cookie Clicker</b>&trade; - Aster Archive Edition</div>
                <div style="color: #A78BFA;">Your saves sync across devices via Firebase!</div>
        </div>
        <div id="game">
                <div id="versionNumber" class="title"></div>
                <script>document.getElementById('versionNumber').innerHTML='v. '+VERSION+' (Firebase Sync)';</script>
                <div id="offGameMessageWrap">
                        <div id="offGameMessage">
                                <div id="loader">
                                        <div class="spinnyBig"></div>
                                        <div class="spinnySmall"></div>
                                </div>
                        </div>
                </div>
        </div>
</div>

</body>
</html>
